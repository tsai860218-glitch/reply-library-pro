<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å›è¦†ç´ æåº« Proï¼ˆå¯è‡ªè¨‚å€åŸŸ/å­åˆ†é¡ï¼‰</title>

  <!-- Google Fontsï¼šNoto Sans TC -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- PWA -->
  <meta name="theme-color" content="#4f46e5" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='36' fill='%234f46e5'/%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' font-size='92'%3E%F0%9F%93%9A%3C/text%3E%3C/svg%3E">

  <style>
    :root{
      --bg: #f6f7fb;
      --surface: #ffffff;
      --text: #101828;
      --muted: #667085;

      --gray-100:#f2f4f7;
      --gray-200:#eaecf0;
      --gray-300:#d0d5dd;

      --indigo-50:#eef2ff;
      --indigo-100:#e0e7ff;
      --indigo-600:#4f46e5;
      --indigo-700:#4338ca;

      --danger-200:#fecdd3;
      --danger-700:#9f1239;

      --shadow: 0 10px 28px rgba(16,24,40,.10);
      --shadow-soft: 0 6px 18px rgba(16,24,40,.08);
      --radius: 16px;
      --radius-sm: 12px;

      --tap: 44px;
    }

    *{box-sizing:border-box}
    body{
      font-family:"Noto Sans TC",system-ui,-apple-system,sans-serif;
      margin:0;background:var(--bg);color:var(--text)
    }
    .wrap{max-width:1040px;margin:0 auto;padding:18px}
    .card{
      background:var(--surface);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow-soft);
      margin:10px 0;
      border:1px solid rgba(234,236,240,.8);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input,select,button,textarea{font:inherit}

    .search{
      flex:1;min-width:240px;
      height:var(--tap);
      padding:12px 14px;
      border:1px solid var(--gray-300);
      border-radius:var(--radius-sm);
      outline:none;background:#fff;
      transition:border-color .15s, box-shadow .15s;
    }
    .search:focus{
      border-color:rgba(79,70,229,.55);
      box-shadow:0 0 0 4px rgba(79,70,229,.14);
    }

    .select{
      height:var(--tap);
      padding:10px 12px;
      border:1px solid var(--gray-300);
      border-radius:var(--radius-sm);
      background:#fff;
      outline:none;
      transition:border-color .15s, box-shadow .15s;
    }
    .select:focus{
      border-color:rgba(79,70,229,.55);
      box-shadow:0 0 0 4px rgba(79,70,229,.14);
    }

    button{
      min-height:var(--tap);
      padding:10px 12px;
      border:0;border-radius:var(--radius-sm);
      cursor:pointer;
      transition:transform .04s, background .15s, border-color .15s, box-shadow .15s, color .15s;
      touch-action:manipulation;
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    /* æŒ‰éˆ•ä¸‰å±¤ï¼šä¸»è¦ / æ¬¡è¦ / åŠŸèƒ½ */
    .btn{ /* ä¸»è¦ï¼ˆå¯¦å¿ƒï¼‰ */
      background:var(--indigo-600);color:#fff;
      box-shadow:0 8px 18px rgba(79,70,229,.20);
    }
    .btn:hover{ background:var(--indigo-700); }
    .btn2{ /* åŠŸèƒ½ï¼ˆæ·ºç°ï¼‰ */
      background:var(--gray-100);color:var(--text);
    }
    .btn2:hover{ background:var(--gray-200); }
    .btn3{ /* æ¬¡è¦ï¼ˆå¤–æ¡†ï¼‰ */
      background:#fff;color:var(--indigo-700);
      border:1px solid rgba(79,70,229,.35);
    }
    .btn3:hover{
      background:var(--indigo-50);
      border-color:rgba(79,70,229,.55);
    }

    .btnDanger{
      background:#fff;
      border:1px solid var(--danger-200);
      color:var(--danger-700);
    }
    .btnDanger:hover{ background:#fff1f2; }

    .btnSmall{min-height:36px;padding:8px 10px;border-radius:12px}

    /* æ¨™ç±¤ï¼šç²‰å½©åº•ï¼‹æ·±è‰²å­— */
    .tag{
      display:inline-block;
      background:var(--indigo-50);
      color:#3730a3;
      padding:5px 10px;
      border-radius:999px;
      font-size:12px;
      margin-right:6px;
      margin-top:6px;
      border:1px solid rgba(79,70,229,.12);
    }
    .chip{display:inline-block;padding:5px 10px;border-radius:999px;font-size:12px;background:var(--gray-100);color:#344054;border:1px solid rgba(208,213,221,.8)}

    .small{font-size:12px;color:var(--muted)}
    .title{font-weight:700;font-size:18px;margin:4px 0 0}
    .kws{margin-top:6px}
    .reply{white-space:pre-wrap;line-height:1.65;margin-top:10px}
    .muted{color:#98a2b3}

    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px;flex-wrap:wrap}
    .pill{
      background:var(--indigo-600);color:#fff;
      padding:6px 10px;border-radius:999px;font-size:12px;
      box-shadow:0 10px 24px rgba(79,70,229,.20);
    }

    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:16px;
      background:var(--text);color:#fff;
      padding:10px 14px;border-radius:999px;
      opacity:0;pointer-events:none;transition:.2s
    }
    .toast.show{opacity:1}

    textarea{
      width:100%;min-height:120px;
      border:1px solid var(--gray-300);
      border-radius:var(--radius-sm);
      padding:12px;
      outline:none;
      transition:border-color .15s, box-shadow .15s;
    }
    textarea:focus{
      border-color:rgba(79,70,229,.55);
      box-shadow:0 0 0 4px rgba(79,70,229,.14);
    }

    details summary{cursor:pointer}

    /* èªæ°£åˆ‡æ›å™¨ï¼šiOS Segmented */
    .seg{
      display:inline-flex;
      padding:4px;
      border:1px solid var(--gray-300);
      border-radius:14px;
      background:var(--gray-100);
      gap:4px;
    }
    .seg button{
      min-height:36px;
      border-radius:12px;
      background:transparent;
      border:0;
      padding:8px 12px;
      color:#344054;
    }
    .seg button.active{
      background:#fff;
      color:var(--indigo-700);
      box-shadow:0 6px 14px rgba(16,24,40,.08);
    }

    /* é¡å¤–ï¼šé è¦½åˆ‡æ›ï¼ˆå¡ç‰‡/æ¢åˆ—ï¼‰ */
    .viewSeg{ margin-left:auto; }
    .divider{height:1px;background:rgba(234,236,240,.9);margin:10px 0}
    .warn{background:#fff7ed;border:1px solid #fed7aa}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 860px){
      .grid2{grid-template-columns:1fr}
      .wrap{padding:14px}
      .row{gap:8px}
      .viewSeg{ margin-left:0; }
      button, .select, .search{ width:100%; }
      .seg{ width:100%; justify-content:space-between; }
      .seg button{ flex:1; }
    }

    .listItem{
      display:flex;gap:8px;align-items:center;justify-content:space-between;
      border:1px solid rgba(234,236,240,.9);
      border-radius:14px;
      padding:12px;
      margin-top:8px;
      background:#fff;
    }
    .listItemLeft{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    .inputSlim{
      height:var(--tap);
      padding:10px 12px;border:1px solid var(--gray-300);
      border-radius:var(--radius-sm);outline:none;background:#fff;
    }
    .inputSlim:focus{
      border-color:rgba(79,70,229,.55);
      box-shadow:0 0 0 4px rgba(79,70,229,.14);
    }

    /* æ¢åˆ—å¼é è¦½æ¨£å¼ */
    .resultList{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .resultRow{
      background:#fff;
      border:1px solid rgba(234,236,240,.95);
      border-radius:18px;
      padding:12px 12px;
      box-shadow:0 10px 26px rgba(16,24,40,.06);
    }
    .resultRowTop{
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
    }
    .resultRowTitle{
      font-weight:700;
      font-size:16px;
      margin-top:4px;
    }
    .resultRowMeta{display:flex;gap:8px;flex-wrap:wrap}
    .resultRowActions{display:flex;gap:8px;flex-wrap:wrap}
    .resultRowReply{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(238,242,255,.55);
      border:1px solid rgba(79,70,229,.10);
      white-space:pre-wrap;line-height:1.65;
    }

    /* âœ… TOP3ï¼šæœå°‹é«˜äº® */
    mark.hl{
      background: rgba(79,70,229,.14);
      color: inherit;
      padding: 0 .12em;
      border-radius: 6px;
    }

    /* âœ… TOP3ï¼šæ¢åˆ—æ”¶åˆï¼ˆ2è¡Œï¼‰ */
    .clamp2{
      display:-webkit-box;
      -webkit-box-orient:vertical;
      -webkit-line-clamp:2;
      overflow:hidden;
    }

    /* âœ… TOP3ï¼šæ¢åˆ—å³å´å›ºå®šæ“ä½œï¼ˆgridï¼‰ */
    .resultRowTop{
      display:grid !important;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:start;
    }
    .resultRowActions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-content:flex-start;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="small">å€åŸŸ/å­åˆ†é¡å¯è‡ªè¨‚ï¼ˆæ–°å¢/åˆªé™¤/ç·¨è¼¯ï¼‰ï½œåˆªé™¤åˆ†é¡æœƒè‡ªå‹•æ”¹æˆã€Œæœªåˆ†é¡ã€ä¸æœƒåˆªç´ æ</div>
        <div class="title">ğŸ“š å›è¦†ç´ æåº« Pro</div>
      </div>
      <div class="row" style="align-items:center">
        <div class="pill" id="countPill">0 å‰‡</div>
        <button class="btn3" id="installHint">ğŸ“² åŠ åˆ°æ¡Œé¢</button>
      </div>
    </div>

    <!-- æœå°‹å€ -->
    <div class="card">
      <div class="row">
        <input id="q" class="search" placeholder="ä¾‹ï¼šå¤ªè²´ / æ«ƒæª¯å£“åŠ› / æ´¾å·¥ / åˆ†æœŸ / ä¸å¥½æ„æ€â€¦ï¼ˆå¯è¼¸å…¥å¤šå€‹è©ï¼‰">

        <select id="zone" class="select">
          <option value="">å…¨éƒ¨å€åŸŸ</option>
        </select>

        <select id="cat" class="select">
          <option value="">å…¨éƒ¨å­åˆ†é¡</option>
        </select>

        <select id="sort" class="select">
          <option value="score">æ’åºï¼šæœ€ç¬¦åˆ</option>
          <option value="used">æ’åºï¼šæœ€è¿‘ä½¿ç”¨</option>
          <option value="fav">æ’åºï¼šå¸¸ç”¨ç½®é ‚</option>
        </select>

        <button class="btn2" id="clear">æ¸…ç©º</button>
      </div>

      <div class="row" style="margin-top:10px;align-items:center">
        <label class="small"><input type="checkbox" id="onlyFav"> åªçœ‹å¸¸ç”¨</label>
        <label class="small"><input type="checkbox" id="onlyRecent"> åªçœ‹æœ€è¿‘ç”¨é</label>

        <div class="seg" title="åŒä¸€ç´ æå¯åˆ‡æ›ä¸‰ç¨®èªæ°£">
          <button class="active" data-tone="soft">ğŸ§¸æº«æŸ”</button>
          <button data-tone="neutral">ğŸ™‚ä¸­æ€§</button>
          <button data-tone="firm">ğŸ‘ å¼·å‹¢</button>
        </div>

        <!-- âœ… é è¦½åˆ‡æ›éµ -->
        <div class="seg viewSeg" title="åˆ‡æ›é è¦½æ¨£å¼">
          <button class="active" data-view="card">ğŸ§© å¡ç‰‡</button>
          <button data-view="list">ğŸ“„ æ¢åˆ—</button>
        </div>

        <span class="small muted" id="hint"></span>
      </div>

      <div class="divider"></div>

      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="small muted" id="synHint"></div>
        <div class="row" style="gap:8px">
          <button class="btn3" id="exportBtn">â¬‡ï¸ åŒ¯å‡ºå‚™ä»½(JSON)</button>
          <button class="btn3" id="importBtn">â¬†ï¸ åŒ¯å…¥(JSON)</button>
          <input type="file" id="filePick" accept="application/json" style="display:none" />
        </div>
      </div>
    </div>

    <!-- åˆ†é¡ç®¡ç† -->
    <div class="card">
      <details>
        <summary class="small">ğŸ§© åˆ†é¡ç®¡ç†ï¼ˆå€åŸŸ/å­åˆ†é¡ï¼šæ–°å¢ã€åˆªé™¤ã€ç·¨è¼¯ï¼‰</summary>
        <div style="margin-top:12px" class="grid2">
          <!-- Zones -->
          <div class="card" style="box-shadow:none">
            <div class="title" style="font-size:16px">å€åŸŸï¼ˆå¤§åˆ†é¡ï¼‰</div>
            <div class="small muted">ä¾‹å¦‚ï¼šåœ˜éšŠæºé€š / å®¢æˆ¶æºé€š / åº—å‹™/æ«ƒæª¯ / å”®å¾Œ/æ´¾å·¥</div>

            <div class="row" style="margin-top:10px">
              <input id="zoneNew" class="inputSlim" style="flex:1;min-width:220px" placeholder="æ–°å¢å€åŸŸåç¨±">
              <button class="btn btnSmall" id="zoneAdd">æ–°å¢</button>
            </div>

            <div id="zoneList"></div>
          </div>

          <!-- Categories -->
          <div class="card" style="box-shadow:none">
            <div class="title" style="font-size:16px">å­åˆ†é¡ï¼ˆå°åˆ†é¡ï¼‰</div>
            <div class="small muted">å­åˆ†é¡å¿…é ˆéš¸å±¬æŸå€‹å€åŸŸï¼ˆä¾‹å¦‚ï¼šå®¢æˆ¶æºé€š â†’ åƒ¹æ ¼/é‚€ç´„/è·Ÿé€²ï¼‰</div>

            <div class="row" style="margin-top:10px">
              <select id="catZoneNew" class="select" style="flex:1;min-width:220px"></select>
              <input id="catNew" class="inputSlim" style="flex:2;min-width:220px" placeholder="æ–°å¢å­åˆ†é¡åç¨±">
              <button class="btn btnSmall" id="catAdd">æ–°å¢</button>
            </div>

            <div id="catList"></div>
          </div>
        </div>

        <div class="small muted" style="margin-top:10px">
          åˆªé™¤å€åŸŸ/å­åˆ†é¡æ™‚ï¼šç´ æä¸æœƒè¢«åˆªé™¤ï¼Œæœƒè‡ªå‹•æ”¹æˆ <span class="chip">æœªåˆ†é¡</span>ã€‚
        </div>
      </details>
    </div>

    <!-- æ–°å¢ç´ æ -->
    <div class="card">
      <details>
        <summary class="small">â• æ–°å¢ç´ æï¼ˆå€åŸŸ/å­åˆ†é¡å¯ä¸‹æ‹‰ï¼Œä¹Ÿå¯è¼¸å…¥å¾ŒåŠ å…¥æ¸…å–®ï¼‰</summary>
        <div style="margin-top:10px">
          <div class="row">
            <select id="newZone" class="select" style="flex:1;min-width:240px"></select>
            <input id="newZoneCustom" class="inputSlim" style="flex:1;min-width:240px" placeholder="æˆ–è¼¸å…¥æ–°å€åŸŸï¼ˆå¯ç•™ç©ºï¼‰">
            <button class="btn3 btnSmall" id="newZoneApply">åŠ å…¥å€åŸŸ</button>
          </div>

          <div class="row" style="margin-top:10px">
            <select id="newCat" class="select" style="flex:1;min-width:240px"></select>
            <input id="newCatCustom" class="inputSlim" style="flex:1;min-width:240px" placeholder="æˆ–è¼¸å…¥æ–°å­åˆ†é¡ï¼ˆå¯ç•™ç©ºï¼‰">
            <button class="btn3 btnSmall" id="newCatApply">åŠ å…¥å­åˆ†é¡</button>
          </div>

          <div class="row" style="margin-top:10px">
            <input id="newTitle" class="search" placeholder="æ¨™é¡Œï¼ˆä¾‹ï¼šå®¢æˆ¶å«Œè²´æ€éº¼å›ï¼‰">
          </div>

          <div class="row" style="margin-top:10px">
            <input id="newKw" class="search" placeholder="é—œéµå­—ï¼ˆé€—è™Ÿåˆ†éš”ï¼Œå¦‚ï¼šå¤ªè²´,åƒ¹æ ¼,åˆ†æ”¤ï¼‰">
          </div>

          <div class="divider"></div>

          <div class="small muted">ğŸ§¸æº«æŸ”ç‰ˆ</div>
          <textarea id="newReplySoft" placeholder="å›è¦†å…§å®¹ï¼ˆæº«æŸ”åŒç†ï¼‰"></textarea>

          <div class="small muted" style="margin-top:10px">ğŸ™‚ä¸­æ€§ç‰ˆ</div>
          <textarea id="newReplyNeutral" placeholder="å›è¦†å…§å®¹ï¼ˆæ¸…æ¥šä¸­æ€§ï¼Œå¯ç•™ç©º=æ²¿ç”¨æº«æŸ”ç‰ˆï¼‰"></textarea>

          <div class="small muted" style="margin-top:10px">ğŸ‘ å¼·å‹¢ç‰ˆ</div>
          <textarea id="newReplyFirm" placeholder="å›è¦†å…§å®¹ï¼ˆç«‹å ´æ˜ç¢ºï¼Œå¯ç•™ç©º=æ²¿ç”¨æº«æŸ”ç‰ˆï¼‰"></textarea>

          <div class="row" style="margin-top:10px;justify-content:flex-end">
            <button class="btn" id="add">æ–°å¢</button>
          </div>

          <div class="small muted">ç´ ææœƒå­˜åˆ°æ­¤ç€è¦½å™¨ localStorageï¼ˆä¸æœƒä¸Šå‚³ï¼‰ã€‚</div>
        </div>
      </details>
    </div>

    <!-- åŒç¾©å­— -->
    <div class="card warn">
      <details>
        <summary class="small">ğŸ§  åŒç¾©å­—å­—å…¸ï¼ˆå¯ç›´æ¥æ”¹ï¼‰</summary>
        <div style="margin-top:10px" class="small muted">
          ä½ æ‰“ã€Œå¤ªè²´ã€æœƒè‡ªå‹•åŒ…å«ã€Œåƒ¹æ ¼/è²»ç”¨/é ç®—/è²´ã€ç­‰åŒç¾©å­—ã€‚
        </div>
        <textarea id="synEditor" class="mono"></textarea>
        <div class="row" style="margin-top:10px;justify-content:flex-end">
          <button class="btn3" id="synReset">é‡ç½®</button>
          <button class="btn" id="synSave">å„²å­˜å­—å…¸</button>
        </div>
      </details>
    </div>

    <div id="list"></div>
  </div>

  <div class="toast" id="toast">å·²è¤‡è£½</div>

<script>
/** ========== PWAï¼šå‹•æ…‹ manifestï¼ˆå–®æª”å³å¯ï¼‰ ========== */
(function injectManifest(){
  const manifest = {
    name: "å›è¦†ç´ æåº« Pro",
    short_name: "ç´ æåº«",
    start_url: ".",
    display: "standalone",
    background_color: "#f6f7fb",
    theme_color: "#4f46e5",
    icons: [
      {
        src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='96' fill='%234f46e5'/%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' font-size='260'%3E%F0%9F%93%9A%3C/text%3E%3C/svg%3E",
        sizes: "512x512",
        type: "image/svg+xml"
      }
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const link = document.createElement("link");
  link.rel = "manifest";
  link.href = url;
  document.head.appendChild(link);
})();

/** ========== keys ========== */
const LS_ITEMS = "reply_items_v2";
const LS_USED  = "reply_used_v2";
const LS_FAV   = "reply_fav_v2";
const LS_TONE  = "reply_tone_v2";
const LS_SYN   = "reply_syn_v2";
const LS_ZONES = "reply_zones_v2";
const LS_CATS  = "reply_cats_v2";
const LS_VIEW  = "reply_view_v2"; // âœ… view mode

/** ========== defaults ========== */
const DEFAULT_ZONE = "æœªåˆ†é¡";
const DEFAULT_CAT  = "æœªåˆ†é¡";

const seedItems = [
  {
    id: "p_price_1",
    zone: "å®¢æˆ¶æºé€š",
    title: "åƒ¹æ ¼å¤ªè²´ï¼ˆåŒç†â†’èªªæ˜â†’çµ¦é¸æ“‡ï¼‰",
    category: "åƒ¹æ ¼",
    keywords: ["å¤ªè²´","åƒ¹æ ¼","è²»ç”¨","é ç®—","è²´","åˆ†æ”¤"],
    replies: {
      soft: "æˆ‘æ‡‚ï½è½åˆ°è²»ç”¨ç¬¬ä¸€åæ‡‰çœŸçš„æœƒè¦ºå¾—æœ‰é»é«˜ğŸ¥º\n\næˆ‘è·Ÿå¦³èªªæ˜ä¸€ä¸‹ï¼šé€™å€‹æ˜¯ã€Œææ–™ï¼‹æ–½å·¥ã€çš„æ¨™æº–æ”¶è²»ï¼Œæ‰€ä»¥é‡‘é¡æœƒæ˜¯é€™æ¨£ã€‚\nå¦‚æœç¾å ´éœ€è¦é¡å¤–æ‹‰é›»æˆ–æ”¹ç®¡ç·šï¼ŒæŠ€å¸«æ‰æœƒä¾å¯¦éš›ç‹€æ³å¦å¤–å ±åƒ¹ã€‚\n\nå¦³å¦‚æœå¸Œæœ›ï¼Œæˆ‘å€‘ä¹Ÿå¯ä»¥ä¸€èµ·æƒ³å€‹å¦³æ¯”è¼ƒèˆ’æœçš„åšæ³•ï¼ˆä¾‹å¦‚åˆ†æ®µ/åˆ†æ”¤ï¼‰ã€‚",
      neutral: "è·Ÿå¦³èªªæ˜ä¸€ä¸‹ï¼šæ­¤é …ç›®è²»ç”¨ç‚ºã€Œææ–™ï¼‹æ–½å·¥ã€çš„æ¨™æº–æ”¶è²»ã€‚\nè‹¥ç¾å ´éœ€è¦é¡å¤–æ‹‰é›»/æ”¹ç®¡ç·šï¼ŒæŠ€å¸«æœƒä¾å¯¦éš›ç‹€æ³å¦å¤–å ±åƒ¹ã€‚\nå¦‚æœä½ æƒ³ï¼Œæˆ‘ä¹Ÿå¯ä»¥æä¾›å¹¾ç¨®è™•ç†æ–¹å¼è®“ä½ é¸æ“‡ï¼ˆä¾‹å¦‚åˆ†æ®µ/åˆ†æ”¤ï¼‰ã€‚",
      firm: "æˆ‘ç†è§£ä½ åœ¨æ„è²»ç”¨ã€‚\nä½†é€™é …ç›®æ˜¯ã€Œææ–™ï¼‹æ–½å·¥ã€çš„æ¨™æº–æ”¶è²»ï¼Œæ‰€ä»¥é‡‘é¡å›ºå®šã€‚\nè‹¥ç¾å ´æœ‰é¡å¤–æ–½å·¥éœ€æ±‚ï¼ŒæŠ€å¸«æ‰æœƒå¦å¤–å ±åƒ¹ã€‚\nä½ æ–¹ä¾¿çš„è©±ï¼Œæˆ‘å€‘å°±ä¾æ¨™æº–æµç¨‹å®‰æ’ï¼›è‹¥è¦æš«ç·©ä¹Ÿæ²’å•é¡Œã€‚"
    }
  },
  {
    id: "p_counter_1",
    zone: "åº—å‹™/æ«ƒæª¯",
    title: "é¢å°é™Œç”Ÿå®¢äººå£“åŠ›å¤§ï¼ˆæ«ƒæª¯ä¸€æ•´å¤©ï¼‰",
    category: "å®‰æ’«",
    keywords: ["å£“åŠ›","ç·Šå¼µ","é™Œç”Ÿ","æ«ƒæª¯","å®³æ€•","æƒ³å“­","å®¢äºº"],
    replies: {
      soft: "æˆ‘æ‡‚ä½ ç¾åœ¨é‚£ç¨®å£“åŠ›ğŸ¥º å…ˆä¸ç”¨é€¼è‡ªå·±ä¸€å®šè¦å¾ˆæœƒèŠã€‚\nä½ æ˜å¤©åªè¦åšåˆ° 3 ä»¶äº‹å°±å¾ˆç©©ï¼š\n1) å¾®ç¬‘ï¼‹å›ºå®šé–‹å ´\n2) è½æ¸…æ¥šéœ€æ±‚ã€é‡è¤‡ä¸€æ¬¡ç¢ºèª\n3) ä¸ç¢ºå®šå°±èªªã€Œæˆ‘å¹«æ‚¨ç¢ºèªä¸€ä¸‹ã€\n\nå›ºå®šé–‹å ´ï¼š\nã€Œæ‚¨å¥½ï½ä»Šå¤©æƒ³äº†è§£/éœ€è¦æˆ‘å¹«æ‚¨ä»€éº¼å‘¢ï¼Ÿã€",
      neutral: "æ˜å¤©ä½ å¯ä»¥ç”¨å›ºå®šæµç¨‹é™ä½å£“åŠ›ï¼š\n1) å…ˆå•éœ€æ±‚ï¼šæ‚¨å¥½ï½ä»Šå¤©éœ€è¦æˆ‘å¹«ä»€éº¼ï¼Ÿ\n2) éœ€æ±‚è¤‡è¿°ç¢ºèªï¼šå¥½çš„æˆ‘å†ç¢ºèªä¸€ä¸‹â€¦\n3) ä¸ç¢ºå®šå°±èªªï¼šæˆ‘å¹«æ‚¨ç¢ºèªä¸€ä¸‹ã€‚\nç…§æµç¨‹èµ°å°±ä¸æœƒæ…Œã€‚",
      firm: "ä½ ä¸éœ€è¦è¨å¥½æ‰€æœ‰äººï¼Œä½ åªéœ€è¦æŠŠæµç¨‹åšå¥½ã€‚\nå›ºå®šé–‹å ´ã€ç¢ºèªéœ€æ±‚ã€éœ€è¦å°±è½‰äº¤/è«‹åŒäº‹å”åŠ©ã€‚\næŠŠä½ èƒ½æ§åˆ¶çš„äº‹åšåˆ°ä½ï¼Œå°±å¤ å°ˆæ¥­äº†ã€‚"
    }
  },
  {
    id: "p_service_1",
    zone: "å”®å¾Œ/æ´¾å·¥",
    title: "æ´¾å·¥æ™‚é–“ç¢ºèªï¼ˆ3-4 è¡Œï¼‰",
    category: "æ™‚é–“ç¢ºèª",
    keywords: ["æ´¾å·¥","é ç´„","æŠ€å¸«","æ–½å·¥","å®‰è£","ä¸è¦é€±äºŒ"],
    replies: {
      soft: "é˜¿å§¨æ—©å®‰ï½è·Ÿå¦³ç¢ºèªä¸€ä¸‹æ´¾å·¥å‚™è¨»ï¼š\n1) åˆ†æµæ”¹éµé ¸ï¼ˆéœ€è¦åŠ è£éµé ¸ï¼‰\n2) åœ°é»ï¼šå…«é‡Œé¾ç±³è·¯ä¸€æ®µ237è™Ÿ10æ¨“\n3) æ™‚é–“ï¼šç›¡é‡ä¸è¦æ’é€±äºŒ\né€™æ¨£å¯«æœ‰æ²’æœ‰æ¼æ‰ä»€éº¼å‘¢ï¼Ÿ",
      neutral: "è·Ÿæ‚¨ç¢ºèªæ´¾å·¥å‚™è¨»ï¼š\n1) åˆ†æµæ”¹éµé ¸ï¼ˆåŠ è£éµé ¸ï¼‰\n2) åœ°é»ï¼šå…«é‡Œé¾ç±³è·¯ä¸€æ®µ237è™Ÿ10æ¨“\n3) æ´¾å·¥ï¼šé¿å…é€±äºŒ\nè«‹å•æ˜¯å¦æ­£ç¢ºï¼Ÿ",
      firm: "æˆ‘é€™é‚Šå…ˆä¾ä»¥ä¸‹å…§å®¹å‚™è¨»æ´¾å·¥ï¼šåˆ†æµæ”¹éµé ¸ã€åœ°é»å…«é‡Œé¾ç±³è·¯ä¸€æ®µ237è™Ÿ10æ¨“ã€é¿å…é€±äºŒã€‚\nè‹¥æœ‰å…¶ä»–é™åˆ¶è«‹ç›´æ¥è£œå……ã€‚"
    }
  },
  {
    id: "p_team_1",
    zone: "åœ˜éšŠæºé€š",
    title: "è¡Œç¨‹è¨è«–æé†’ï¼ˆä¸æŒ‡è²¬ã€æŠŠè¦å‰‡è¬›æ¸…æ¥šï¼‰",
    category: "è¦ç¯„/æé†’",
    keywords: ["æé†’","è¦å‰‡","è¡Œç¨‹","è¨è«–","æ³¨æ„","ç¦®è²Œ"],
    replies: {
      soft: "å¤§å®¶æé†’ä¸€ä¸‹ï½ğŸ™ ä¹‹å¾Œå¦‚æœéœ€è¦åœ¨åˆ¥äººçš„è»Šä¸Šåƒæ±è¥¿ï¼Œå…ˆå•ä¸€ä¸‹è»Šä¸»æ¯”è¼ƒç¦®è²Œä¹Ÿé¿å…èª¤æœƒã€‚\næˆ‘å€‘éƒ½å¸Œæœ›è¡Œç¨‹é–‹å¿ƒé †é †çš„ï½è¬è¬å¤§å®¶é…åˆâ¤ï¸",
      neutral: "æé†’å¤§å®¶ï¼šè‹¥è¦åœ¨ä»–äººè»Šä¸Šåƒæ±è¥¿ï¼Œè«‹å…ˆå¾µè©¢è»Šä¸»åŒæ„ï¼Œé¿å…é€ æˆä¸èˆ’æœæˆ–èª¤æœƒã€‚è¬è¬é…åˆã€‚",
      firm: "çµ±ä¸€è¦ç¯„ï¼šè»Šä¸Šé£²é£Ÿè«‹å…ˆå•éè»Šä¸»åŒæ„ï¼Œæœªç¶“åŒæ„è«‹ä¸è¦åœ¨è»Šå…§é£Ÿç”¨ã€‚ä¹‹å¾Œè«‹ç…§é€™å€‹è¦å‰‡èµ°ã€‚"
    }
  }
];

const defaultSyn = {
  "å¤ªè²´": ["è²´","åƒ¹æ ¼","è²»ç”¨","é ç®—","åƒ¹éŒ¢","æˆæœ¬"],
  "æ´¾å·¥": ["æŠ€å¸«","æ–½å·¥","å®‰è£","åˆ°åºœ","é ç´„"],
  "ç·Šå¼µ": ["å£“åŠ›","å®³æ€•","ç„¦æ…®","æƒ³å“­","ä¸å®‰"],
  "åˆ†æœŸ": ["åˆ·å¡","æœŸæ•¸","æœˆä»˜","ä¿¡ç”¨å¡","æ¯æœŸ"],
  "é“æ­‰": ["ä¸å¥½æ„æ€","æŠ±æ­‰","å°ä¸èµ·","å¤±ç¦®"],
  "åœ˜éšŠ": ["å¤¥ä¼´","ç¾¤çµ„","é ˜å°","æœƒè­°","è¡Œç¨‹","è¦ç¯„"],
  "å®¢æˆ¶": ["é˜¿å§¨","é¡§å®¢","å®¢äºº","å®¢æˆ¶ç«¯","å°æ–¹"]
};

/** ========== utils ========== */
function escapeHtml(s){ return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function escapeAttr(s){ return (s||"").replace(/"/g,"&quot;"); }
function normalize(s){ return (s||"").toString().toLowerCase().trim(); }
function toast(msg="å®Œæˆ") {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 900);
}
async function copyText(text) {
  try { await navigator.clipboard.writeText(text); toast("å·²è¤‡è£½"); }
  catch {
    const ta = document.createElement("textarea");
    ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy");
    document.body.removeChild(ta);
    toast("å·²è¤‡è£½");
  }
}
function idgen(){ return "u_" + Math.random().toString(16).slice(2); }

/* âœ… TOP3ï¼šå‘½ä¸­è© / é«˜äº® */
function getHits(item, qParts){
  if(!qParts?.length) return [];
  const text = normalize([
    item.zone, item.title, item.category, (item.keywords||[]).join(","),
    item.replies?.soft, item.replies?.neutral, item.replies?.firm
  ].join(" "));
  const hits = [];
  for(const p of qParts){
    if(!p || p.length < 2) continue;
    if(text.includes(p)) hits.push(p);
  }
  return Array.from(new Set(hits)).slice(0,8);
}
function highlightEscaped(escapedText, terms){
  if(!terms?.length) return escapedText;
  let out = escapedText;
  const sorted = [...terms].sort((a,b)=>b.length-a.length);
  for(const t of sorted){
    const re = new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), "gi");
    out = out.replace(re, (m)=>`<mark class="hl">${m}</mark>`);
  }
  return out;
}
const expandedIds = new Set();

/** ========== storage load/save ========== */
function loadJSON(key, fallback){
  try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
  catch{ return fallback; }
}
function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }

/** ========== state ========== */
let items = [];
let used = {};
let fav = {};
let tone = "soft";
let syn = {};
let zones = [];
let cats = [];
let viewMode = localStorage.getItem(LS_VIEW) || "card";

/** ========== init merge seed ========== */
function ensureDefaults(){
  const loadedItems = loadJSON(LS_ITEMS, null);
  items = Array.isArray(loadedItems) ? loadedItems : [];

  const map = new Map(items.map(x => [x.id, x]));
  for(const s of seedItems) if(!map.has(s.id)) map.set(s.id, s);

  items = Array.from(map.values()).map(it => {
    if(!it.zone) it.zone = DEFAULT_ZONE;
    if(!it.category) it.category = DEFAULT_CAT;
    if(!it.keywords) it.keywords = [];
    if(!it.replies && it.reply){
      it.replies = {soft: it.reply, neutral: it.reply, firm: it.reply};
      delete it.reply;
    }
    if(!it.replies) it.replies = {soft:"", neutral:"", firm:""};
    return it;
  });
  saveJSON(LS_ITEMS, items);

  used = loadJSON(LS_USED, {});
  fav  = loadJSON(LS_FAV, {});
  tone = localStorage.getItem(LS_TONE) || "soft";
  syn  = loadJSON(LS_SYN, defaultSyn);

  const loadedZones = loadJSON(LS_ZONES, null);
  const loadedCats  = loadJSON(LS_CATS, null);

  if(Array.isArray(loadedZones) && loadedZones.length){
    zones = loadedZones;
  } else {
    zones = Array.from(new Set(items.map(x => x.zone))).filter(Boolean);
  }
  if(!zones.includes(DEFAULT_ZONE)) zones.unshift(DEFAULT_ZONE);

  if(Array.isArray(loadedCats) && loadedCats.length){
    cats = loadedCats;
  } else {
    const set = new Set();
    const out = [];
    for(const it of items){
      const z = it.zone || DEFAULT_ZONE;
      const c = it.category || DEFAULT_CAT;
      const k = z + "||" + c;
      if(!set.has(k)){
        set.add(k);
        out.push({zone: z, name: c});
      }
    }
    cats = out;
  }

  for(const z of zones){
    if(!cats.some(x => x.zone===z && x.name===DEFAULT_CAT)){
      cats.push({zone: z, name: DEFAULT_CAT});
    }
  }

  saveJSON(LS_ZONES, zones);
  saveJSON(LS_CATS, cats);
  saveJSON(LS_SYN, syn);
}

function expandQuery(q){
  const parts = normalize(q).split(/\s+/).filter(Boolean);
  const expanded = new Set(parts);
  for(const p of parts){
    for(const [k, arr] of Object.entries(syn)){
      const nk = normalize(k);
      if (p === nk || nk.includes(p) || p.includes(nk)) {
        expanded.add(nk);
        (arr||[]).forEach(w => expanded.add(normalize(w)));
      }
    }
  }
  return Array.from(expanded).filter(Boolean);
}

function scoreItem(item, qParts){
  if(!qParts.length) return 0;
  const text = normalize([
    item.zone, item.title, item.category, (item.keywords||[]).join(","),
    item.replies?.soft, item.replies?.neutral, item.replies?.firm
  ].join(" "));
  const kwText = normalize((item.keywords||[]).join(" "));
  let score = 0;
  for (const p of qParts){
    if (!p) continue;
    if (text.includes(p)) score += 5;
    if (p.length <= 2 && text.includes(p)) score += 2;
    if (kwText.includes(p)) score += 6;
  }
  return score;
}

/** ========== DOM refs ========== */
const elQ = document.getElementById("q");
const elZone = document.getElementById("zone");
const elCat = document.getElementById("cat");
const elSort = document.getElementById("sort");
const elCount = document.getElementById("countPill");
const elHint = document.getElementById("hint");
const elSynHint = document.getElementById("synHint");
const elOnlyFav = document.getElementById("onlyFav");
const elOnlyRecent = document.getElementById("onlyRecent");
const toneButtons = [...document.querySelectorAll(".seg button[data-tone]")];
const viewButtons = [...document.querySelectorAll(".seg button[data-view]")];

const elZoneList = document.getElementById("zoneList");
const elCatList  = document.getElementById("catList");

const elNewZone = document.getElementById("newZone");
const elNewZoneCustom = document.getElementById("newZoneCustom");
const elNewCat = document.getElementById("newCat");
const elNewCatCustom = document.getElementById("newCatCustom");

const elZoneNew = document.getElementById("zoneNew");
const elCatZoneNew = document.getElementById("catZoneNew");
const elCatNew = document.getElementById("catNew");

const synEditor = document.getElementById("synEditor");

/** ========== selectors build ========== */
function buildZoneOptions(selectEl, includeAllLabel){
  const opts = [];
  if(includeAllLabel) opts.push(`<option value="">${includeAllLabel}</option>`);
  for(const z of zones){
    opts.push(`<option value="${escapeAttr(z)}">${escapeHtml(z)}</option>`);
  }
  selectEl.innerHTML = opts.join("");
}

function buildCatOptions(selectEl, zoneValue, includeAllLabel){
  const opts = [];
  if(includeAllLabel) opts.push(`<option value="">${includeAllLabel}</option>`);
  const list = zoneValue
    ? cats.filter(x => x.zone === zoneValue).map(x => x.name)
    : Array.from(new Set(cats.map(x => x.name)));

  const uniq = Array.from(new Set(list)).filter(Boolean).sort((a,b)=>a.localeCompare(b,'zh-Hant'));
  for(const c of uniq){
    opts.push(`<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`);
  }
  selectEl.innerHTML = opts.join("");
}

function refreshAllSelectors(keepSelection=true){
  const prevZone = elZone.value;
  const prevCat  = elCat.value;

  buildZoneOptions(elZone, "å…¨éƒ¨å€åŸŸ");
  if(keepSelection && zones.includes(prevZone)) elZone.value = prevZone;

  buildCatOptions(elCat, elZone.value, "å…¨éƒ¨å­åˆ†é¡");
  if(keepSelection && prevCat){
    const exists = Array.from(elCat.options).some(o => o.value === prevCat);
    if(exists) elCat.value = prevCat;
  }

  buildZoneOptions(elNewZone, null);
  if(!elNewZone.value) elNewZone.value = zones[0] || DEFAULT_ZONE;

  buildCatOptions(elNewCat, elNewZone.value, null);
  if(!elNewCat.value) elNewCat.value = DEFAULT_CAT;

  buildZoneOptions(elCatZoneNew, null);
  if(!elCatZoneNew.value) elCatZoneNew.value = zones[0] || DEFAULT_ZONE;
}

/** ========== management render ========== */
function renderZoneManager(){
  elZoneList.innerHTML = zones.map(z => {
    const locked = (z === DEFAULT_ZONE);
    return `
      <div class="listItem">
        <div class="listItemLeft">
          <span class="chip">${locked ? "ä¿ç•™" : "å¯ç·¨è¼¯"}</span>
          <span class="tag">${escapeHtml(z)}</span>
        </div>
        <div class="row" style="gap:8px;align-items:center">
          <button class="btn3 btnSmall" data-act="zoneEdit" data-zone="${escapeAttr(z)}" ${locked?"disabled":""}>ç·¨è¼¯</button>
          <button class="btnDanger btnSmall" data-act="zoneDel" data-zone="${escapeAttr(z)}" ${locked?"disabled":""}>åˆªé™¤</button>
        </div>
      </div>
    `;
  }).join("");

  elZoneList.querySelectorAll("button[data-act]").forEach(btn => {
    btn.addEventListener("click", () => {
      const act = btn.dataset.act;
      const z = btn.dataset.zone;
      if(act === "zoneEdit") editZone(z);
      if(act === "zoneDel") deleteZone(z);
    });
  });
}

function renderCatManager(){
  const z = elCatZoneNew.value || DEFAULT_ZONE;
  const list = cats.filter(x => x.zone === z).sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant'));
  elCatList.innerHTML = list.map(c => {
    const locked = (c.name === DEFAULT_CAT);
    return `
      <div class="listItem">
        <div class="listItemLeft">
          <span class="chip">${escapeHtml(c.zone)}</span>
          <span class="tag">${locked ? "æœªåˆ†é¡" : escapeHtml(c.name)}</span>
        </div>
        <div class="row" style="gap:8px;align-items:center">
          <button class="btn3 btnSmall" data-act="catEdit" data-zone="${escapeAttr(c.zone)}" data-cat="${escapeAttr(c.name)}" ${locked?"disabled":""}>ç·¨è¼¯</button>
          <button class="btnDanger btnSmall" data-act="catDel" data-zone="${escapeAttr(c.zone)}" data-cat="${escapeAttr(c.name)}" ${locked?"disabled":""}>åˆªé™¤</button>
        </div>
      </div>
    `;
  }).join("");

  elCatList.querySelectorAll("button[data-act]").forEach(btn => {
    btn.addEventListener("click", () => {
      const act = btn.dataset.act;
      const z = btn.dataset.zone;
      const c = btn.dataset.cat;
      if(act === "catEdit") editCat(z,c);
      if(act === "catDel") deleteCat(z,c);
    });
  });
}

/** ========== zone CRUD ========== */
function addZone(name){
  const z = (name||"").trim();
  if(!z) return toast("è«‹è¼¸å…¥å€åŸŸåç¨±");
  if(zones.includes(z)) return toast("é€™å€‹å€åŸŸå·²å­˜åœ¨");
  zones.push(z);
  if(!cats.some(x => x.zone===z && x.name===DEFAULT_CAT)){
    cats.push({zone: z, name: DEFAULT_CAT});
  }
  saveJSON(LS_ZONES, zones);
  saveJSON(LS_CATS, cats);
  refreshAllSelectors(true);
  renderZoneManager();
  renderCatManager();
  toast("å·²æ–°å¢å€åŸŸ");
}

function editZone(oldName){
  const next = prompt(`ç·¨è¼¯å€åŸŸåç¨±ï¼š\nã€Œ${oldName}ã€â†’`, oldName);
  if(next === null) return;
  const newName = next.trim();
  if(!newName) return toast("åç¨±ä¸èƒ½ç©ºç™½");
  if(newName === oldName) return;
  if(zones.includes(newName)) return toast("å·²å­˜åœ¨ç›¸åŒåç¨±");

  zones = zones.map(z => z===oldName ? newName : z);
  items = items.map(it => (it.zone===oldName ? ({...it, zone:newName}) : it));
  cats = cats.map(x => (x.zone===oldName ? ({...x, zone:newName}) : x));

  saveJSON(LS_ZONES, zones);
  saveJSON(LS_CATS, cats);
  saveJSON(LS_ITEMS, items);

  refreshAllSelectors(false);
  if(elZone.value === oldName) elZone.value = newName;

  renderZoneManager();
  renderCatManager();
  render();
  toast("å·²æ›´æ–°å€åŸŸ");
}

function deleteZone(name){
  if(!confirm(`ç¢ºå®šåˆªé™¤å€åŸŸã€Œ${name}ã€ï¼Ÿ\n\nç´ æä¸æœƒè¢«åˆªé™¤ï¼Œæœƒè‡ªå‹•æ”¹æˆã€Œ${DEFAULT_ZONE}ã€ã€‚\nè©²å€åŸŸçš„å­åˆ†é¡ä¹Ÿæœƒä¸€ä½µç§»é™¤ã€‚`)) return;

  zones = zones.filter(z => z !== name);
  if(!zones.includes(DEFAULT_ZONE)) zones.unshift(DEFAULT_ZONE);

  items = items.map(it => it.zone===name ? ({...it, zone: DEFAULT_ZONE, category: DEFAULT_CAT}) : it);
  cats = cats.filter(x => x.zone !== name);

  if(!cats.some(x => x.zone===DEFAULT_ZONE && x.name===DEFAULT_CAT)){
    cats.push({zone: DEFAULT_ZONE, name: DEFAULT_CAT});
  }

  saveJSON(LS_ZONES, zones);
  saveJSON(LS_CATS, cats);
  saveJSON(LS_ITEMS, items);

  if(elZone.value === name) elZone.value = "";
  refreshAllSelectors(true);

  renderZoneManager();
  renderCatManager();
  render();
  toast("å·²åˆªé™¤å€åŸŸ");
}

/** ========== category CRUD ========== */
function addCat(zone, catName){
  const z = (zone||DEFAULT_ZONE).trim() || DEFAULT_ZONE;
  const c = (catName||"").trim();
  if(!c) return toast("è«‹è¼¸å…¥å­åˆ†é¡åç¨±");

  if(!zones.includes(z)) return toast("å€åŸŸä¸å­˜åœ¨ï¼ˆè«‹å…ˆæ–°å¢å€åŸŸï¼‰");
  if(cats.some(x => x.zone===z && x.name===c)) return toast("é€™å€‹å­åˆ†é¡å·²å­˜åœ¨");

  cats.push({zone:z, name:c});
  saveJSON(LS_CATS, cats);

  refreshAllSelectors(true);
  renderCatManager();
  toast("å·²æ–°å¢å­åˆ†é¡");
}

function editCat(zone, oldCat){
  const next = prompt(`ç·¨è¼¯å­åˆ†é¡åç¨±ï¼ˆå€åŸŸï¼š${zone}ï¼‰ï¼š\nã€Œ${oldCat}ã€â†’`, oldCat);
  if(next === null) return;
  const newCat = next.trim();
  if(!newCat) return toast("åç¨±ä¸èƒ½ç©ºç™½");
  if(newCat === oldCat) return;
  if(cats.some(x => x.zone===zone && x.name===newCat)) return toast("å·²å­˜åœ¨ç›¸åŒåç¨±");

  cats = cats.map(x => (x.zone===zone && x.name===oldCat) ? ({...x, name:newCat}) : x);
  items = items.map(it => (it.zone===zone && it.category===oldCat) ? ({...it, category:newCat}) : it);

  saveJSON(LS_CATS, cats);
  saveJSON(LS_ITEMS, items);

  refreshAllSelectors(false);
  if(elZone.value===zone && elCat.value===oldCat) elCat.value = newCat;
  if(elNewZone.value===zone && elNewCat.value===oldCat) elNewCat.value = newCat;

  renderCatManager();
  render();
  toast("å·²æ›´æ–°å­åˆ†é¡");
}

function deleteCat(zone, catName){
  if(!confirm(`ç¢ºå®šåˆªé™¤å­åˆ†é¡ã€Œ${catName}ã€ï¼Ÿï¼ˆå€åŸŸï¼š${zone}ï¼‰\n\nç´ æä¸æœƒè¢«åˆªé™¤ï¼Œæœƒè‡ªå‹•æ”¹æˆã€Œ${DEFAULT_CAT}ã€ã€‚`)) return;

  cats = cats.filter(x => !(x.zone===zone && x.name===catName));
  if(!cats.some(x => x.zone===zone && x.name===DEFAULT_CAT)){
    cats.push({zone: zone, name: DEFAULT_CAT});
  }

  items = items.map(it => (it.zone===zone && it.category===catName) ? ({...it, category: DEFAULT_CAT}) : it);

  saveJSON(LS_CATS, cats);
  saveJSON(LS_ITEMS, items);

  refreshAllSelectors(true);
  renderCatManager();
  render();
  toast("å·²åˆªé™¤å­åˆ†é¡");
}

/** âœ… TOP3ï¼šç´ æç®¡ç†ï¼ˆç·¨è¼¯/åˆªé™¤/è¤‡è£½æˆæ–°ï¼‰ */
function ensureZoneCatExist(zone, category){
  if(!zones.includes(zone)) zones.push(zone);
  if(!cats.some(x => x.zone===zone && x.name===category)) cats.push({zone, name: category});
  saveJSON(LS_ZONES, zones);
  saveJSON(LS_CATS, cats);
}
function cloneItem(it){
  const copy = structuredClone(it);
  copy.id = idgen();
  copy.title = `${it.title}ï¼ˆè¤‡è£½ï¼‰`;
  items.push(copy);
  saveJSON(LS_ITEMS, items);
  ensureZoneCatExist(copy.zone || DEFAULT_ZONE, copy.category || DEFAULT_CAT);
  refreshAllSelectors(true);
  renderZoneManager();
  renderCatManager();
  render();
  toast("å·²è¤‡è£½æˆæ–°ç´ æ");
}
function editItem(it){
  const zone = prompt("å€åŸŸï¼ˆå¤§åˆ†é¡ï¼‰", it.zone || DEFAULT_ZONE);
  if(zone === null) return;

  const category = prompt("å­åˆ†é¡ï¼ˆå°åˆ†é¡ï¼‰", it.category || DEFAULT_CAT);
  if(category === null) return;

  const title = prompt("æ¨™é¡Œ", it.title || "");
  if(title === null) return;

  const kw = prompt("é—œéµå­—ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰", (it.keywords||[]).join(","));
  if(kw === null) return;

  const soft = prompt("ğŸ§¸æº«æŸ”ç‰ˆ", it.replies?.soft || "");
  if(soft === null) return;

  const neutral = prompt("ğŸ™‚ä¸­æ€§ç‰ˆï¼ˆç•™ç©ºï¼æ²¿ç”¨æº«æŸ”ç‰ˆï¼‰", it.replies?.neutral || "");
  if(neutral === null) return;

  const firm = prompt("ğŸ‘ å¼·å‹¢ç‰ˆï¼ˆç•™ç©ºï¼æ²¿ç”¨æº«æŸ”ç‰ˆï¼‰", it.replies?.firm || "");
  if(firm === null) return;

  it.zone = (zone.trim() || DEFAULT_ZONE);
  it.category = (category.trim() || DEFAULT_CAT);
  it.title = (title.trim() || it.title);
  it.keywords = (kw||"").split(",").map(s=>s.trim()).filter(Boolean);
  it.replies = {
    soft: soft,
    neutral: (neutral.trim() ? neutral : soft),
    firm: (firm.trim() ? firm : soft)
  };

  saveJSON(LS_ITEMS, items);
  ensureZoneCatExist(it.zone, it.category);

  refreshAllSelectors(true);
  renderZoneManager();
  renderCatManager();
  render();
  toast("å·²æ›´æ–°ç´ æ");
}
function deleteItem(it){
  if(!confirm(`ç¢ºå®šåˆªé™¤é€™å‰‡ç´ æï¼Ÿ\n\n${it.title}`)) return;
  items = items.filter(x => x.id !== it.id);
  delete used[it.id];
  delete fav[it.id];
  expandedIds.delete(it.id);

  saveJSON(LS_ITEMS, items);
  saveJSON(LS_USED, used);
  saveJSON(LS_FAV, fav);

  render();
  toast("å·²åˆªé™¤ç´ æ");
}

/** ========== tone & view & render ========== */
function setTone(t){
  tone = t;
  localStorage.setItem(LS_TONE, tone);
  toneButtons.forEach(b => b.classList.toggle("active", b.dataset.tone === tone));
  render();
}
function setView(v){
  viewMode = v;
  localStorage.setItem(LS_VIEW, viewMode);
  viewButtons.forEach(b => b.classList.toggle("active", b.dataset.view === viewMode));
  render();
}

function render(){
  const q = elQ.value;
  const zone = elZone.value;
  const cat = elCat.value;
  const sort = elSort.value;
  const onlyFav = elOnlyFav.checked;
  const onlyRecent = elOnlyRecent.checked;

  const qParts = q ? expandQuery(q) : [];
  elSynHint.textContent = q ? `åŒç¾©å­—æ“´å±•ï¼š${qParts.slice(0,10).join("ã€")}${qParts.length>10?"â€¦":""}` : "åŒç¾©å­—æ“´å±•ï¼šè¼¸å…¥é—œéµå­—å¾Œæœƒè‡ªå‹•é¡¯ç¤º";
  elHint.textContent = q
    ? `æœå°‹ï¼šã€Œ${q}ã€ï½œèªæ°£ï¼š${tone==="soft"?"æº«æŸ”":tone==="neutral"?"ä¸­æ€§":"å¼·å‹¢"}ï½œé è¦½ï¼š${viewMode==="card"?"å¡ç‰‡":"æ¢åˆ—"}`
    : "æç¤ºï¼šå¯å…ˆé¸ã€Œå€åŸŸã€å†æœå°‹ï¼ˆä¾‹å¦‚ï¼šå®¢æˆ¶æºé€šï¼‹å¤ªè²´ï¼‰";

  let filtered = items.filter(it => {
    if(zone && it.zone !== zone) return false;
    if(cat && it.category !== cat) return false;
    if(onlyFav && !fav[it.id]) return false;
    if(onlyRecent && !used[it.id]) return false;
    if(!qParts.length) return true;
    return scoreItem(it, qParts) > 0;
  });

  if(sort === "score"){
    filtered.sort((a,b) => scoreItem(b,qParts) - scoreItem(a,qParts) || ((used[b.id]||0)-(used[a.id]||0)));
  } else if(sort === "used"){
    filtered.sort((a,b) => (used[b.id]||0) - (used[a.id]||0));
  } else if(sort === "fav"){
    filtered.sort((a,b) => (fav[b.id]?1:0)-(fav[a.id]?1:0) || ((used[b.id]||0)-(used[a.id]||0)));
  }

  elCount.textContent = `${filtered.length} å‰‡`;

  const html = (viewMode === "list")
    ? renderListView(filtered)
    : renderCardView(filtered);

  document.getElementById("list").innerHTML = html;

  document.querySelectorAll("button[data-act]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      const act = btn.dataset.act;
      const it = items.find(x => x.id === id);
      if(!it) return;

      if(act === "copy"){
        const text = (it.replies?.[tone] || it.replies?.soft || "");
        await copyText(text);
        used[id] = Date.now();
        saveJSON(LS_USED, used);
        render();
      }
      if(act === "fav"){
        fav[id] = !fav[id];
        if(!fav[id]) delete fav[id];
        saveJSON(LS_FAV, fav);
        render();
      }

      /* âœ… TOP3 actions */
      if(act === "toggleExpand"){
        if(expandedIds.has(id)) expandedIds.delete(id);
        else expandedIds.add(id);
        render();
      }
      if(act === "clone"){
        cloneItem(it);
      }
      if(act === "edit"){
        editItem(it);
      }
      if(act === "del"){
        deleteItem(it);
      }
    });
  });
}

function renderCardView(filtered){
  const q = elQ.value;
  const qParts = q ? expandQuery(q) : [];

  return filtered.map(it => {
    const tags = [
      it.zone ? `<span class="tag">${escapeHtml(it.zone)}</span>` : "",
      it.category ? `<span class="tag">${escapeHtml(it.category)}</span>` : "",
      fav[it.id] ? `<span class="tag">å¸¸ç”¨</span>` : "",
      used[it.id] ? `<span class="tag">æœ€è¿‘</span>` : ""
    ].join("");

    const hits = getHits(it, qParts);

    const kw = (it.keywords?.length ? it.keywords.slice(0,12) : [])
      .map(k => `<span class="tag">${escapeHtml(k)}</span>`).join("");

    const usedTime = used[it.id] ? new Date(used[it.id]).toLocaleString() : "â€”";
    const replyText = (it.replies?.[tone] || it.replies?.soft || "");

    const titleHtml = highlightEscaped(escapeHtml(it.title), hits);
    const replyHtml = highlightEscaped(escapeHtml(replyText), hits);

    return `
      <div class="card">
        <div class="small">${tags}</div>
        <div class="title">${titleHtml}</div>
        <div class="kws">${kw}</div>

        <div class="small muted" style="margin-top:6px">
          ${hits.length ? `å‘½ä¸­ï¼š${hits.map(h=>escapeHtml(h)).join("ã€")}` : ""}
        </div>

        <div class="reply">${replyHtml}</div>

        <div class="row" style="margin-top:10px;justify-content:space-between;align-items:center">
          <div class="small muted">æœ€è¿‘ä½¿ç”¨ï¼š${escapeHtml(usedTime)}</div>
          <div class="row" style="gap:8px">
            <button class="btn2" data-act="clone" data-id="${escapeAttr(it.id)}">è¤‡è£½æˆæ–°</button>
            <button class="btn3" data-act="edit" data-id="${escapeAttr(it.id)}">ç·¨è¼¯</button>
            <button class="btnDanger" data-act="del" data-id="${escapeAttr(it.id)}">åˆªé™¤</button>
            <button class="btn2" data-act="fav" data-id="${escapeAttr(it.id)}">${fav[it.id] ? "â˜… å–æ¶ˆå¸¸ç”¨" : "â˜† è¨­ç‚ºå¸¸ç”¨"}</button>
            <button class="btn" data-act="copy" data-id="${escapeAttr(it.id)}">ä¸€éµè¤‡è£½</button>
          </div>
        </div>
      </div>
    `;
  }).join("");
}

function renderListView(filtered){
  const rows = filtered.map(it => {
    const tags = [
      it.zone ? `<span class="tag">${escapeHtml(it.zone)}</span>` : "",
      it.category ? `<span class="tag">${escapeHtml(it.category)}</span>` : "",
      fav[it.id] ? `<span class="tag">å¸¸ç”¨</span>` : "",
      used[it.id] ? `<span class="tag">æœ€è¿‘</span>` : ""
    ].join("");

    const q = elQ.value;
    const qParts = q ? expandQuery(q) : [];
    const hits = getHits(it, qParts);

    const kw = (it.keywords?.length ? it.keywords.slice(0,10) : [])
      .map(k => `<span class="tag">${escapeHtml(k)}</span>`).join("");

    const usedTime = used[it.id] ? new Date(used[it.id]).toLocaleString() : "â€”";
    const replyText = (it.replies?.[tone] || it.replies?.soft || "");

    const titleHtml = highlightEscaped(escapeHtml(it.title), hits);
    const replyHtml = highlightEscaped(escapeHtml(replyText), hits);

    const isOpen = expandedIds.has(it.id);

    return `
      <div class="resultRow">
        <div class="resultRowTop">
          <div style="min-width:240px;">
            <div class="resultRowMeta small">${tags}</div>
            <div class="resultRowTitle">${titleHtml}</div>
            <div class="kws">${kw}</div>

            <div class="small muted" style="margin-top:6px">
              æœ€è¿‘ä½¿ç”¨ï¼š${escapeHtml(usedTime)}
              ${hits.length ? `ï½œå‘½ä¸­ï¼š${hits.map(h=>escapeHtml(h)).join("ã€")}` : ""}
            </div>
          </div>

          <div class="resultRowActions">
            <button class="btn3" data-act="toggleExpand" data-id="${escapeAttr(it.id)}">${isOpen ? "æ”¶åˆ" : "å±•é–‹"}</button>
            <button class="btn2" data-act="clone" data-id="${escapeAttr(it.id)}">è¤‡è£½æˆæ–°</button>
            <button class="btn3" data-act="edit" data-id="${escapeAttr(it.id)}">ç·¨è¼¯</button>
            <button class="btnDanger" data-act="del" data-id="${escapeAttr(it.id)}">åˆªé™¤</button>
            <button class="btn3" data-act="fav" data-id="${escapeAttr(it.id)}">${fav[it.id] ? "â˜… å¸¸ç”¨" : "â˜† å¸¸ç”¨"}</button>
            <button class="btn" data-act="copy" data-id="${escapeAttr(it.id)}">è¤‡è£½</button>
          </div>
        </div>

        <div class="resultRowReply ${isOpen ? "" : "clamp2"}">${replyHtml}</div>
      </div>
    `;
  }).join("");

  return `<div class="resultList">${rows}</div>`;
}

/** ========== events ========== */
document.getElementById("clear").addEventListener("click", () => {
  elQ.value = "";
  elZone.value = "";
  elCat.value = "";
  elOnlyFav.checked = false;
  elOnlyRecent.checked = false;
  elSort.value = "score";
  buildCatOptions(elCat, "", "å…¨éƒ¨å­åˆ†é¡");
  render();
});

elQ.addEventListener("input", render);
elZone.addEventListener("change", () => {
  buildCatOptions(elCat, elZone.value, "å…¨éƒ¨å­åˆ†é¡");
  elCat.value = "";
  render();
});
elCat.addEventListener("change", render);
elSort.addEventListener("change", render);
elOnlyFav.addEventListener("change", render);
elOnlyRecent.addEventListener("change", render);

toneButtons.forEach(b => b.addEventListener("click", () => setTone(b.dataset.tone)));
viewButtons.forEach(b => b.addEventListener("click", () => setView(b.dataset.view)));

/** Add zone/cat manager */
document.getElementById("zoneAdd").addEventListener("click", () => {
  addZone(elZoneNew.value);
  elZoneNew.value = "";
});
document.getElementById("catAdd").addEventListener("click", () => {
  addCat(elCatZoneNew.value, elCatNew.value);
  elCatNew.value = "";
});
elCatZoneNew.addEventListener("change", renderCatManager);

/** New item: zone/cat dependent */
elNewZone.addEventListener("change", () => {
  buildCatOptions(elNewCat, elNewZone.value, null);
  if(!elNewCat.value) elNewCat.value = DEFAULT_CAT;
});

document.getElementById("newZoneApply").addEventListener("click", () => {
  const z = elNewZoneCustom.value.trim();
  if(!z) return toast("è«‹è¼¸å…¥æ–°å€åŸŸ");
  addZone(z);
  elNewZone.value = z;
  buildCatOptions(elNewCat, z, null);
  elNewCat.value = DEFAULT_CAT;
  elNewZoneCustom.value = "";
});

document.getElementById("newCatApply").addEventListener("click", () => {
  const z = elNewZone.value || DEFAULT_ZONE;
  const c = elNewCatCustom.value.trim();
  if(!c) return toast("è«‹è¼¸å…¥æ–°å­åˆ†é¡");
  addCat(z, c);
  elNewCat.value = c;
  elNewCatCustom.value = "";
});

/** Add item */
document.getElementById("add").addEventListener("click", () => {
  const zone = elNewZone.value || DEFAULT_ZONE;
  const category = elNewCat.value || DEFAULT_CAT;
  const title = document.getElementById("newTitle").value.trim();
  const kw = document.getElementById("newKw").value.split(",").map(s=>s.trim()).filter(Boolean);
  const soft = document.getElementById("newReplySoft").value.trim();
  const neutral = document.getElementById("newReplyNeutral").value.trim() || soft;
  const firm = document.getElementById("newReplyFirm").value.trim() || soft;

  if(!title || !soft) return toast("æ¨™é¡Œèˆ‡æº«æŸ”ç‰ˆå›è¦†å¿…å¡«");

  const id = idgen();
  items.push({id, zone, category, title, keywords: kw, replies: {soft, neutral, firm}});
  saveJSON(LS_ITEMS, items);

  if(!zones.includes(zone)){ zones.push(zone); }
  if(!cats.some(x => x.zone===zone && x.name===category)){ cats.push({zone, name: category}); }
  saveJSON(LS_ZONES, zones);
  saveJSON(LS_CATS, cats);

  ["newTitle","newKw","newReplySoft","newReplyNeutral","newReplyFirm"].forEach(i => document.getElementById(i).value = "");
  refreshAllSelectors(true);
  renderZoneManager();
  renderCatManager();
  render();
  toast("å·²æ–°å¢ç´ æ");
});

/** Export/Import */
function download(filename, text) {
  const blob = new Blob([text], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
document.getElementById("exportBtn").addEventListener("click", () => {
  const payload = {
    version: 2,
    exportedAt: new Date().toISOString(),
    items, used, fav, tone, syn, zones, cats,
    viewMode
  };
  download(`reply_library_backup_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(payload, null, 2));
  toast("å·²åŒ¯å‡ºå‚™ä»½");
});
document.getElementById("importBtn").addEventListener("click", () => {
  document.getElementById("filePick").click();
});
document.getElementById("filePick").addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const text = await file.text();
    const obj = JSON.parse(text);
    if(!obj || typeof obj!=="object" || !Array.isArray(obj.items)) return toast("æ ¼å¼ä¸æ­£ç¢º");

    items = obj.items;
    used = obj.used && typeof obj.used==="object" ? obj.used : {};
    fav  = obj.fav  && typeof obj.fav==="object"  ? obj.fav  : {};
    tone = obj.tone || "soft";
    syn  = obj.syn  && typeof obj.syn==="object"  ? obj.syn  : defaultSyn;
    zones = Array.isArray(obj.zones) ? obj.zones : [DEFAULT_ZONE];
    cats  = Array.isArray(obj.cats)  ? obj.cats  : [{zone:DEFAULT_ZONE,name:DEFAULT_CAT}];
    viewMode = (obj.viewMode === "list" || obj.viewMode === "card") ? obj.viewMode : (localStorage.getItem(LS_VIEW) || "card");

    items = items.map(it => {
      if(!it.zone) it.zone = DEFAULT_ZONE;
      if(!it.category) it.category = DEFAULT_CAT;
      if(!it.keywords) it.keywords = [];
      if(!it.replies && it.reply){
        it.replies = {soft: it.reply, neutral: it.reply, firm: it.reply};
        delete it.reply;
      }
      if(!it.replies) it.replies = {soft:"", neutral:"", firm:""};
      return it;
    });
    if(!zones.includes(DEFAULT_ZONE)) zones.unshift(DEFAULT_ZONE);
    for(const z of zones){
      if(!cats.some(x => x.zone===z && x.name===DEFAULT_CAT)) cats.push({zone:z,name:DEFAULT_CAT});
    }

    saveJSON(LS_ITEMS, items);
    saveJSON(LS_USED, used);
    saveJSON(LS_FAV, fav);
    localStorage.setItem(LS_TONE, tone);
    saveJSON(LS_SYN, syn);
    saveJSON(LS_ZONES, zones);
    saveJSON(LS_CATS, cats);
    localStorage.setItem(LS_VIEW, viewMode);

    refreshAllSelectors(false);
    setTone(tone);
    setView(viewMode);
    renderZoneManager();
    renderCatManager();
    renderSynEditor();
    render();
    toast("å·²åŒ¯å…¥");
  } catch {
    toast("åŒ¯å…¥å¤±æ•—");
  } finally {
    e.target.value = "";
  }
});

/** Syn editor */
function renderSynEditor(){ synEditor.value = JSON.stringify(syn, null, 2); }
document.getElementById("synSave").addEventListener("click", () => {
  try{
    const obj = JSON.parse(synEditor.value);
    if(!obj || typeof obj!=="object") throw new Error("bad");
    syn = obj;
    saveJSON(LS_SYN, syn);
    toast("å·²å„²å­˜å­—å…¸");
    render();
  }catch{
    toast("å­—å…¸æ ¼å¼éŒ¯èª¤");
  }
});
document.getElementById("synReset").addEventListener("click", () => {
  syn = structuredClone(defaultSyn);
  saveJSON(LS_SYN, syn);
  renderSynEditor();
  toast("å·²é‡ç½®");
  render();
});

/** PWA install hint */
document.getElementById("installHint").addEventListener("click", () => {
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  if (isIOS) alert("iPhone/iPadï¼šè«‹ç”¨ Safari é–‹å•Ÿæœ¬é  â†’ é»ã€Œåˆ†äº«ã€â†’ é¸ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ã€‚");
  else alert("Android/Chromeï¼šç¶²å€åˆ—å³å´é€šå¸¸æœƒæœ‰ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€æˆ–ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ã€‚\nï¼ˆè‹¥æ²’æœ‰ï¼Œè«‹ç”¨ https æˆ– localhost é–‹å•Ÿï¼‰");
});

/** ========== start ========== */
ensureDefaults();
refreshAllSelectors(true);
renderZoneManager();
renderCatManager();
renderSynEditor();
setTone(tone);
setView(viewMode);
render();
</script>
</body>
</html>
